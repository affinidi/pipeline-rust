on:
  workflow_call:
    inputs:
      toolchain:
        required: false
        type: string
        default: stable
      rustflags:
        required: false
        type: string
        default: ""
      ubuntu-rust-deps:
        required: false
        type: string
        default: libdbus-1-dev libssl-dev

jobs:
  verify-publish:
    name: Verify Publishable
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: ${{ inputs.toolchain }}
          rustflags: ${{ inputs.rustflags }}
          override: true
      - uses: affinidi/pipeline-rust/.github/actions/rust-dependencies@main
        with:
          ubuntu-rust-deps: ${{ inputs.ubuntu-rust-deps }}
      - name: Verify all crates can be packaged
        run: |
          echo "Verifying all workspace crates can be packaged..."
          failed=""
          for crate in $(cargo metadata --format-version=1 --no-deps | jq -r '.packages[].name'); do
            echo -n "Checking $crate... "
            # Suppress deprecation warnings during package check
            if output=$(RUSTFLAGS="${{ inputs.rustflags }} -A deprecated" cargo package -p "$crate" --allow-dirty 2>&1); then
              echo "OK"
            else
              echo "FAILED"
              echo "$output" | tail -20
              failed="$failed $crate"
            fi
          done
          if [ -n "$failed" ]; then
            echo ""
            echo "Failed crates:$failed"
            exit 1
          fi
          echo ""
          echo "All crates ready to publish"
